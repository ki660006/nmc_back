Imports System.Windows.Forms
Imports System.IO
Imports System.Xml
Imports System.Data.OracleClient

Imports DBORA.DbProvider
Imports COMMON.CommFN
Imports COMMON.CommLogin.LOGIN
Imports COMMON.SVar

Public Class CGWEB_B


    Public Function ExecuteDo_Out(ByVal r_al_OutInfo As ArrayList) As Boolean
        Dim sFn As String = "Public Function ExecuteDo_Out(ArrayList) As Boolean"

        Try
            COMMON.CommFN.MdiMain.DB_Active_YN = "Y"

            Dim sRetVal As String
            Dim bRetval As Boolean


            For ix As Integer = 0 To r_al_OutInfo.Count - 1

                Dim sURL = ""
                Dim wbReq As Net.WebRequest
                Dim wbRep As Net.WebResponse

#If DEBUG Then
                sURL += PRG_CONST.SERVERIP_DEV
#Else
            sURL += PRG_CONST.SERVERIP
#End If
                sURL = PRG_CONST.SERVERIP
                sURL += "/webapps/com/commonweb/xrw/.live?submit_id=TXLIW00201&business_id=lis"
                sURL += "&instcd=" + PRG_CONST.SITECD
                sURL += "&bldno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).BLDNO
                sURL += "&comcd_out=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).COMCD_OUT
                sURL += "&tnsjubsuno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).TNSJUBSUNO
                sURL += "&comcd=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).COMCD
                sURL += "&owngbn=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).OWNGBN
                sURL += "&fkocs=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).FKOCS.Split("-"c)(0)
                sURL += "&regno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).REGNO
                sURL += "&recid=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).RECID
                sURL += "&recnm=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).RECNM
                sURL += "&abo=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).ABO

                If CType(r_al_OutInfo(ix), STU_TnsJubsu).RH = "+" Then
                    sURL += "&rh=＋"
                ElseIf CType(r_al_OutInfo(ix), STU_TnsJubsu).RH = "-" Then
                    sURL += "&rh=－"
                End If
                sURL += "&usrid=" + IIf(USER_INFO.USRID.IndexOf("ACK") >= 0, "410276", USER_INFO.USRID).ToString
                sURL += "&usrip=" + USER_INFO.LOCALIP
                sURL += "&rs_retval="
                sURL += "&"

                wbReq = Net.WebRequest.Create(sURL)
                wbRep = wbReq.GetResponse()

                Dim sr As System.IO.StreamReader = New System.IO.StreamReader(wbRep.GetResponseStream(), System.Text.Encoding.UTF8)
                sRetVal = fnGet_XmlParsing(sr)

            Next

            If sRetVal.Substring(0, 2) = "00" Then
                bRetval = True
            Else
                bRetval = False
            End If


            Return bRetval

        Catch ex As Exception
            Throw (New Exception(ex.Message + " @" + sFn, ex))
        Finally
            COMMON.CommFN.MdiMain.DB_Active_YN = ""
        End Try
    End Function

    Public Function ExecuteDo_Out_cancle(ByVal r_al_OutInfo As ArrayList, ByVal rsOutGbn As String) As Boolean
        Dim sFn As String = "Public Function ExecuteDo_Out(ArrayList) As Boolean"

        Try
            COMMON.CommFN.MdiMain.DB_Active_YN = "Y"

            Dim sRetVal As String
            Dim bRetval As Boolean


            For ix As Integer = 0 To r_al_OutInfo.Count - 1

                Dim sURL = ""
                Dim wbReq As Net.WebRequest
                Dim wbRep As Net.WebResponse

#If DEBUG Then
                sURL += PRG_CONST.SERVERIP_DEV
#Else
            sURL += PRG_CONST.SERVERIP
#End If

                sURL += "/webapps/com/commonweb/xrw/.live?submit_id=TXLIW00202&business_id=lis"
                sURL += "&instcd=" + PRG_CONST.SITECD
                sURL += "&outgbn=" + rsOutGbn
                sURL += "&bldno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).BLDNO
                sURL += "&comcd_out=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).COMCD_OUT
                sURL += "&tnsjubsuno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).TNSJUBSUNO
                sURL += "&comcd=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).COMCD
                sURL += "&owngbn=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).OWNGBN
                sURL += "&fkocs=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).FKOCS.Split("-"c)(0)
                sURL += "&regno=" + CType(r_al_OutInfo(ix), STU_TnsJubsu).REGNO
                
                sURL += "&usrid=" + IIf(USER_INFO.USRID.IndexOf("ACK") >= 0, "410276", USER_INFO.USRID).ToString
                sURL += "&usrip=" + USER_INFO.LOCALIP
                sURL += "&rs_retval="
                sURL += "&"

                wbReq = Net.WebRequest.Create(sURL)
                wbRep = wbReq.GetResponse()

                Dim sr As System.IO.StreamReader = New System.IO.StreamReader(wbRep.GetResponseStream(), System.Text.Encoding.UTF8)
                sRetVal = fnGet_XmlParsing(sr)

            Next

            If sRetVal.Substring(0, 2) = "00" Then
                bRetval = True
            Else
                bRetval = False
            End If


            Return bRetval

        Catch ex As Exception
            Throw (New Exception(ex.Message + " @" + sFn, ex))
        Finally
            COMMON.CommFN.MdiMain.DB_Active_YN = ""
        End Try
    End Function

    Private Function fnGet_XmlParsing(ByVal r_sr As System.IO.StreamReader) As String

        Dim sFn As String = "fnGet_XmlParsing"

        Dim xmlReader As XmlTextReader = New Xml.XmlTextReader(r_sr)
        Dim sValue As String = ""

        Try
            While xmlReader.Read()
                Select Case xmlReader.NodeType
                    Case XmlNodeType.Comment
                    Case XmlNodeType.Element
                        If xmlReader.Name.ToLower = "data" Then
                            If sValue <> "" Then
                                sValue += Chr(4)
                            End If
                        End If
                    Case XmlNodeType.EndEntity
                    Case XmlNodeType.Text
                        sValue += xmlReader.Value.Trim + Chr(3)
                    Case XmlNodeType.CDATA
                        sValue += xmlReader.Value.Trim + Chr(3)
                    Case Else
                End Select
            End While

        Catch ex As XmlException
            Throw (New Exception(ex.Message, ex))

        Finally
            xmlReader.Close()
        End Try

        Return sValue

    End Function
End Class
